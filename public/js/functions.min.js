function start_google_maps(){var e="";if($("#map").length===0)return;var t={zoom:MAP_DEFAULT_ZOOM,center:new google.maps.LatLng(MAP_DEFAULT_LAT,MAP_DEFAULT_LNG),mapTypeId:google.maps.MapTypeId.ROADMAP,scrollwheel:!0};MAP=new google.maps.Map(document.getElementById("map"),t)}function start_facebook(){if($("#fb-root").length===0)return;FB_APP_ID=$("#fb-root").attr("data-fb-id");window.fbAsyncInit=function(){FB.init({appId:FB_APP_ID,status:!0,cookie:!0,xfbml:!0,oauth:!0})};(function(){var e=document.createElement("script");e.async=!0;e.src=document.location.protocol+"//connect.facebook.net/en_US/all.js";document.getElementById("fb-root").appendChild(e)})();$("#fb-auth").live("click",function(){fbLogin()})}function fbLogin(){showLoader(!0);FB.login(function(e){e.authResponse?FB.api("/me",function(t){login(e,t)}):showLoader(!1)},{scope:"email,user_birthday,status_update,publish_stream,user_about_me"})}function fbUpdateButton(e){FB_BUTTON=$("#fb-auth");FB_USERINFO=$("#user-info");if(!FB_BUTTON||!FB_USERINFO)return;FB.Event.subscribe("auth.statusChange",fbUpdateButton);if(e.authResponse){FB.api("/me",function(t){login(e,t)});FB_BUTTON.onclick=function(){FB.logout(function(e){logout(e)})}}}function login(e,t){if(e.authResponse){var n="";n=n+"facebook_access_token="+e.authResponse.accessToken;n=n+"&name="+t.name;n=n+"&email="+t.email;n=n+"&facebook_id="+t.id;n+="&form=facebook";$.ajax({type:"POST",url:"/ajax/add-marker-step-2",data:n,success:function(e){showLoader(!1);e=jsonToObject(e);formFeedback(e.status_msg,e.status);if(e.status==STATUS_OK){checkUserStatus();e.map_point&&loadAddMarkerStep3(e.map_point)}},error:function(e,t,n){showLoader(!1);formFeedback("Erro interno, tente novamente mais tarde.",STATUS_ERROR)}})}}function logout(e){FB_USERINFO.innerHTML="";document.getElementById("debug").innerHTML="";document.getElementById("other").style.display="none";showLoader(!1)}function streamPublish(e,t,n,r,i){showLoader(!0);FB.ui({method:"stream.publish",message:"",attachment:{name:e,caption:"",description:t,href:r},action_links:[{text:n,href:r}],user_prompt_message:i},function(e){showLoader(!1)})}function showStream(){FB.api("/me",function(e){streamPublish(e.name,"I like the articles of Thinkdiff.net","hrefTitle","http://thinkdiff.net","Share thinkdiff.net")})}function share(){showLoader(!0);var e={method:"stream.share",u:"http://thinkdiff.net/"};FB.ui(e,function(e){showLoader(!1);console.log(e)})}function graphStreamPublish(){showLoader(!0);FB.api("/me/feed","post",{message:"I love thinkdiff.net for facebook app development tutorials",link:"http://ithinkdiff.net",picture:"http://thinkdiff.net/iphone/lucky7_ios.jpg",name:"iOS Apps & Games",description:"Checkout iOS apps and games from iThinkdiff.net. I found some of them are just awesome!"},function(e){showLoader(!1);!e||e.error?alert("Error occured"):alert("Post ID: "+e.id)})}function fqlQuery(){showLoader(!0);FB.api("/me",function(e){showLoader(!1);var t=FB.Data.query("select name, profile_url, sex, pic_small from user where uid={0}",e.id);t.wait(function(e){document.getElementById("debug").innerHTML="FQL Information: <br />Your name: "+e[0].name+"<br />"+"Your Sex: "+(e[0].sex!==undefined?e[0].sex:"")+"<br />"+"Your Profile: "+"<a href='"+e[0].profile_url+"'>"+e[0].profile_url+"</a>"+"<br />"+'<img src="'+e[0].pic_small+'" alt="" />'+"<br />"})})}function setStatus(){showLoader(!0);status1=document.getElementById("status").value;FB.api({method:"status.set",status:status1},function(e){e===0?alert("Your facebook status not updated. Give Status Update Permission."):alert("Your facebook status updated");showLoader(!1)})}function showLoader(e){$loader=$("#loader");if($loader.length===0)return;e?$loader.show():$loader.hide()}function validate_form_sign_up(){$("#submit-sign-up","#signup").live("click",function(){$("#signup").validate({rules:{name:{required:!0,minlength:3},email:{required:!0,email:!0,remote:"ajax/check-email"},password:{required:!0},password_confirm:{required:!0,equalTo:"#password"}},messages:{name:{required:"O campo nome é obrigatorio.",minlength:"O campo nome deve conter mais de 3 caracteres."},email:{required:"O campo email é obrigatorio.",email:"Email inválido.",remote:"Email já cadastrado."},password:{required:"O campo senha é obrigatorio."},password_confirm:{required:"O campo de confirmação de senha é obrigatorio.",equalTo:"O campo senha e confirmação de senha devem ser iguais."}},submitHandler:function(e){var t=$(e).serialize();showLoader(!0);$.ajax({type:"POST",url:"/ajax/add-marker-step-2/",data:t+"&form=signup",success:function(t){showLoader(!1);t=jsonToObject(t);formFeedback(t.status_msg,t.status);if(t.status==STATUS_OK){e.reset();checkUserStatus();t.map_point&&loadAddMarkerStep3(t.map_point)}},error:function(e,t,n){showLoader(!1);formFeedback("Erro interno, tente novamente mais tarde.",STATUS_ERROR)}});return!1}})})}function validate_form_sign_in(){$("#submit-sign-in","#signin").live("click",function(){$("#signin").validate({rules:{email:{required:!0,email:!0},password:{required:!0}},messages:{email:{required:"O campo email é obrigatorio.",email:"Email inválido."},password:{required:"O campo senha é obrigatorio."}},submitHandler:function(e){showLoader(!0);var t=$(e).serialize();$.ajax({type:"POST",url:"/ajax/add-marker-step-2/",data:t+"&form=signin",success:function(t){showLoader(!1);t=jsonToObject(t);formFeedback(t.status_msg,t.status);if(t.status==STATUS_OK){e.reset();checkUserStatus();t.map_point&&loadAddMarkerStep3(t.map_point)}},error:function(e,t,n){showLoader(!1);formFeedback("Erro interno, tente novamente mais tarde.",STATUS_ERROR)}});return!1}})})}function validate_form_add_marker(){checkMarkerExists();checkTypeChange();$("#submit-add-marker","#addmarker").live("click",function(){$("#addmarker").validate({rules:{address:{required:!0},neighborhood:{required:!0},city:{required:!0},state:{required:!0},title:{required:!0},type:{required:!0},content:{required:!0},category:{required:!0}},messages:{address:{required:"O campo endereço é obrigatório."},neighborhood:{required:"O campo bairro é obrigatório."},city:{required:"O campo cidade é obrigatório."},state:{required:"Escolha o estado."},title:{required:"O campo titulo é obrigatório."},type:{required:"Escolha o tipo."},content:{required:"O campo conteúdo é obrigatório."},category:{required:"Escolha a categoria."}},submitHandler:function(e){var t=!1,n=$("#content","#addmarker").val(),r=$("#type","#addmarker").val();switch(r){case"1":checkYoutubeURL(n)?t=!0:formFeedback("O conteúdo não é uma url do Youtube válida.",STATUS_ERROR);break;case"2":checkImageURL(n)?t=!0:formFeedback("O conteúdo não é uma url de Imagem válida.",STATUS_ERROR);break;case"3":n.length===0?formFeedback("O conteúdo não contém texto.",STATUS_ERROR):t=!0}if(t){$("#form-feedback").fadeOut();showLoader(!0);var i=$(e).serialize();$.ajax({type:"POST",url:"/ajax/add-marker-step-1",data:i+"&form=add_marker",success:function(e){showLoader(!1);e=jsonToObject(e);formFeedback(e.status_msg,e.status);e.status==STATUS_OK&&openModalWithUrl("/usuario/")},error:function(e,t,n){showLoader(!1);formFeedback("Erro interno, tente novamente mais tarde.",STATUS_ERROR)}})}return!1}})})}function validate_form_contact(){$("#submit-contact","#contact").live("click",function(){$("#contact").validate({rules:{name:{required:!0},email:{required:!0,email:!0},message:{required:!0}},messages:{name:{required:"O campo nome é obrigatorio."},email:{required:"O campo email é obrigatorio.",email:"Email inválido."},message:{required:"O campo mensagem é obrigatorio."}},submitHandler:function(e){showLoader(!0);var t=$(e).serialize();$.ajax({type:"POST",url:"/ajax/contato",data:t,success:function(t){showLoader(!1);t=jsonToObject(t);formFeedback(t.status_msg,t.status);t.status==STATUS_OK&&e.reset()},error:function(e,t,n){showLoader(!1);formFeedback("Erro interno, tente novamente mais tarde.",STATUS_ERROR)}});return!1}})})}function validate_form_search(){$("#submit-search","#search").live("click",function(){$("#search").validate({submitHandler:function(e){var t=$(e).serialize();globalFeedbackShow("Carregando...");$.ajax({type:"POST",url:"/ajax/get-markers",data:t,success:function(e){e=jsonToObject(e);if(e.status==STATUS_OK){var t=0,n=new google.maps.LatLngBounds;if(e.count>0){$.each(MAP_MARKERS_ARRAY,function(e,t){t.setMap(null)});$.each(e.markers,function(e,r){n.extend(new google.maps.LatLng(r.latitude,r.longitude));setTimeout(function(){setMarker(e,r)},t)});MAP.fitBounds(n);globalFeedbackHide()}}},error:function(e,t,n){formFeedback("Erro interno, tente novamente mais tarde.",STATUS_ERROR);globalFeedbackHide()}});return!1}})})}function checkTypeChange(){$("#type","#addmarker").live("change",function(){$select=$(this);$content=$("#content","#addmarker");var e=$select.val();switch(e){case"1":$content.css({height:"26px",resize:"none"});$('label[for="content"]',"#addmarker").text("Link do youtube");break;case"2":$content.css({height:"26px",resize:"none"});$('label[for="content"]',"#addmarker").text("Link da imagem");break;default:$content.css("height","120px");$('label[for="content"]',"#addmarker").text("Texto")}$content.focus()})}function checkImageURL(e){var t=!1,n;try{n=document.createElement("img");n.src=e}catch(r){t=!1}n.height>0&&(t=!0);return t}function checkYoutubeURL(e){return youtubeCodeParser(e)?!0:!1}function youtubeCodeParser(e){var t=/^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/,n=e.match(t);return n&&n[7].length==11?n[7]:!1}function checkMarkerExists(){$("input, select","#addmarker").live("blur",function(){var e="http://maps.google.com/maps/api/staticmap?center=-17.930178,-43.790845&zoom=3&size=960x200&sensor=false",t=0,n=0,r=$("#address","#addmarker"),i=$("#neighborhood","#addmarker"),s=$("#city","#addmarker"),o=$("#state","#addmarker"),u=$("#type","#addmarker"),a=$("#content","#addmarker"),f=[r.val(),i.val(),s.val(),o.val()].join(" ");MAP_GEOCODER.geocode({address:f},function(r,i){if(i==google.maps.GeocoderStatus.OK){t=r[0].geometry.location.lat();n=r[0].geometry.location.lng();e="http://maps.google.com/maps/api/staticmap?center="+t+","+n+"&markers="+t+","+n+"&zoom=15&size=960x200&sensor=false"}$("#map-preview").attr("src",e);$("#latitude","#addmarker").val(t);$("#longitude","#addmarker").val(n)})})}function openModalWithUrl(e){globalFeedbackShow("Carregando...");$(".modal-content").load(e,function(){$(".modal-container").show();$(this).find('[class^="modal"]').hasClass("modal-form")&&$(this).addClass("wide");globalFeedbackHide()})}function closeModalClick(){$(".close-modal").live("click",function(){$(".modal-container").fadeOut();setHash("");return!1})}function hideModal(e){$(e).fadeOut(1e3,function(){$(e).modal("hide")})}function goToAddMarkerStep3(){$.ajax({type:"POST",url:"/ajax/add-marker-step-2/",data:"form=none",success:function(e){showLoader(!1);e=jsonToObject(e);formFeedback(e.status_msg,e.status);e.status==STATUS_OK&&e.map_point&&loadAddMarkerStep3(e.map_point)},error:function(e,t,n){showLoader(!1);formFeedback("Erro interno, tente novamente mais tarde.",STATUS_ERROR)}})}function loadAddMarkerStep3(e){openModalWithUrl("/mapa/"+e+"/?type=key");getMarkers()}function checkUserStatus(){$user_status=$("#user-status");$("#user-logout").hide();$("#add-marker").hide();$user_status.html('<a href="#" onclick="return false;"><i class="icon-info-sign icon-white"></i>  Aguarde...</a>');$.ajax({type:"POST",url:"/ajax/user-status",success:function(e){e=jsonToObject(e);if(e.status==STATUS_OK){$user_status.html('<a href="#" onclick="return false;">'+e.user.name+"</a>");$("#user-logout").show();$("#add-marker").show();return!0}$user_status.html('<a class="link-modal"  href="/usuario/">Cadastro/Login</a>');return!1},error:function(e,t,n){showLoader(!1);formFeedback("Erro interno, tente novamente mais tarde.",STATUS_ERROR)}})}function formFeedback(e,t){t=t==STATUS_OK?"success":"error";$feedback=$("#form-feedback");$feedback.removeClass("alert-success").removeClass("alert-error");$feedback.addClass("alert-"+t).text(e).show()}function jsonToObject(json){return eval("("+json+")")}function getMarkers(){if($("#map").length===0)return;var e=null;globalFeedbackShow("Carregando...");$.ajax({type:"POST",url:"/ajax/get-markers",data:e,success:function(e){var e=jsonToObject(e);if(e.status==STATUS_OK){var t=0,n=new google.maps.LatLngBounds;if(e.count>0){$.each(e.markers,function(e,r){n.extend(new google.maps.LatLng(r.latitude,r.longitude));setTimeout(function(){setMarker(e,r)},t)});MAP.fitBounds(n);globalFeedbackHide()}else globalFeedbackHide()}else globalFeedbackHide();$("#categories").fadeIn()}})}function setMarker(e,t){var n=new google.maps.MarkerImage("/images/shadow.png",new google.maps.Size(59,43),new google.maps.Point(0,0),new google.maps.Point(18,21)),r={coord:[1,1,1,37,43,59,43,1],type:"poly"};t.icon_file="/uploads/marker/"+t.icon_file;var i=new google.maps.MarkerImage(t.icon_file,new google.maps.Size(37,43),new google.maps.Point(0,0),new google.maps.Point(18,21)),s=new google.maps.LatLng(t.latitude,t.longitude),o=new google.maps.Marker({position:s,map:MAP,shadow:n,icon:i,shape:r,title:t.category,zIndex:e});o.setValues({category:t.category_id,latitude:t.latitude,longitude:t.longitude,visible:!0});MAP_MARKERS_ARRAY.push(o);var u=new google.maps.InfoWindow({map:MAP,content:'<div class="modal-header"><h4>'+t.title+'</h4></div><div class="modal-body">'+t.content+'<br><a class="deep-link" href="'+t.slug+'">ver</a></div>',position:new google.maps.LatLng(t.latitude,t.longitude),shadowStyle:1,padding:0,backgroundColor:"#ffffff",borderRadius:4,borderWidth:1,borderColor:"#2c2c2c",disableAutoPan:!0,hideCloseButton:!0,arrowSize:15,arrowPosition:50,arrowStyle:0,backgroundClassName:"phoney",maxWidth:800,minWidth:300,maxHeight:400,minHeight:250,width:800,height:400});MAP_INFO_WINDOW_ARRAY.push(u);u.close();google.maps.event.addListener(o,"click",function(){setHash(t.slug);return!1})}function toggleMarkers(){$("ul li a","#categories").click(function(){var e=[],t,n=$(this).attr("id").replace("category_","");if($(this).hasClass("enabled")){$(this).addClass("disabled").removeClass("enabled");t=!1}else{$(this).addClass("enabled").removeClass("disabled");t=!0}$("ul li a","#categories").each(function(t,n){$(this).hasClass("disabled")&&e.push($(this).attr("id").replace("category_",""))});var r=new google.maps.LatLngBounds,i=0;$.each(MAP_MARKERS_ARRAY,function(e,r){r.category==n&&r.setVisible(t)});MAP_CURRENT_INFOWINDOW&&MAP_CURRENT_INFOWINDOW.close();return!1})}function setHash(e){window.location.hash=e}function getDeepLinks(){var e="";$(".deep-link").live("click",function(){setHash($(this).attr("href"));return!1});$(window).bind("hashchange",function(){e=window.location.hash.substring(1);e&&openModalWithUrl(e)});$(window).trigger("hashchange")}function globalFeedbackShow(e){$("#global-feedback").show();$("span","#global-feedback").text(e)}function globalFeedbackHide(){$("#global-feedback").hide();$("span","#global-feedback").text("")}var STATUS_OK="ok",STATUS_ERROR="error",MAP,MAP_DEFAULT_LAT="-19.925370823375808",MAP_DEFAULT_LNG="-44.054517175",MAP_DEFAULT_ZOOM=6,MAP_SET_MARKER_TIME=200,MAP_INFO_WINDOW_ARRAY=[],MAP_MARKERS_ARRAY=[],MAP_GEOCODER=new google.maps.Geocoder,MAP_MARKER_TIME=200,MAP_CURRENT_INFOWINDOW=null,FB_APP_ID,FB_BUTTON,FB_USERINFO;$(document).ready(function(){start_google_maps();start_facebook();$("a.link-modal").live("click",function(){var e=$(this),t=e.attr("href");e.attr("href","#");if(t!="#"){openModalWithUrl(t);e.attr("href",t);return!1}});$(".modal-container").on("hidden",function(){setHash("")});closeModalClick();validate_form_sign_up();validate_form_sign_in();validate_form_add_marker();validate_form_contact();validate_form_search();checkUserStatus();getMarkers();toggleMarkers();getDeepLinks()});